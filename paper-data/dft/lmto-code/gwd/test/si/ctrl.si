# Uncomment this line to run with SO>0
# SYMGRP  i*r3(1,1,-1):(1/4,1/4,1/4) r4x:(1/4,1/4,1/4)
TESTLMF lmfa si
        lmf si --no-iactiv --oldvc
        rm -f mixm.si
TSTMPIK lmfa si
        mpirun -n 4 lmf si --no-iactiv --oldvc
        rm -f mixm.si
TESTGW  lmfgwd --jobgw=-1 --oldvc si --make-Q0P
        lmfgwd --jobgw=0  --oldvc si --gwcode=0
        lmfgwd --jobgw=1  --oldvc si --gwcode=0 # --shorbz=no
        lmf2gw_0 si
TESTGW2 lmfgwd --jobgw=-1 --oldvc si --make-Q0P
        lmfgwd --jobgw=0  --oldvc si --gwcode=2
        lmfgwd --jobgw=1  --oldvc si --gwcode=2
        lmf2gw_2 si
TSTMPID lmfgwd --jobgw=-1 --oldvc si --make-Q0P
        lmfgwd --jobgw=0 --oldvc si --gwcode=2
        mpirun -n 4 lmfgwd --jobgw=1 --oldvc si --gwcode=2
        lmf2gw_2 si
TESTSIG lmf si -vsig=12 --rs=1,0 -vnit=1 --pr45 --no-iactiv
TSIGT
   echo band pass before transformation ...
   rm -f mixm.si
   lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --no-iactiv --rsig:ascii
   echo Rewrite sigm with approximate high-energy part:
   lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --rsig:ascii --wsig:trans=3
   echo use modified sigm.si and save for future tests
   cp sigm2.si sigm.si
   cp sigm.si sigm.si~
   echo Transformation to LDA basis, slightly offset k mesh
   lmf si -vsig=12 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq:fbz:trans=1
   echo Eigenvectors in LDA basis, slightly offset k mesh
   lmf si -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq:fbz:trans=4
   echo Transformation back to orbital basis to demonstrate recovers original sigm
   lmf si -vsig=11 --wsig:trans=-1
   echo band pass with transformed sigm --- evals should be unchanged
   cp sigm3.si sigm.si
   rm -f mixm.si
   lmf si -vsig=12 -vemaxs=2 --rsig:fbz:shftq --rs=1,0 -vnit=1 --pr45 --no-iactiv
   echo Show transformation to smaller orbital basis: ES lmax=2 -> lmax=1
   cp sigm.si~ sigm.si
   lmf si -vlmxe=1 -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq:fbz:trans=4
   echo Transformation of sigm to orbital basis
   lmf si -vlmxe=1 -vsig=11 --wsig:trans=-1
   echo band pass with transformed sigm, smaller basis
   cp sigm3.si sigm.si
   rm -f mixm.si
   lmf si -vlmxe=1 -vsig=12 -vemaxs=2 --rsig:fbz:shftq --rs=1,0 -vnit=1 --pr45 --no-iactiv
#  Same calculation, with larger shftq
#   lmf si -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq=.05,.05,.05:fbz:trans=2
#   lmf si -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq=.05,.05,.05:fbz:trans=4
#   lmf si -vsig=11 --wsig:trans=-1
#   cp sigm3.si sigm.si
#   lmf si -vsig=12 -vemaxs=2 --rsig:fbz:shftq=.05,.05,.05 --rs=1,0 -vnit=1 --pr45 --no-iactiv
#  Same calculation, with larger shftq, not FBZ
#   lmf si -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq=.05,.05,.05:trans=2
#   lmf si -vsig=11 -vnk=4 -vbzjob=0 -vemaxs=2 --wsig:shftq=.05,.05,.05:trans=4
#   lmf si -vsig=11 --wsig:trans=-1
#   cp sigm3.si sigm.si
#   lmf si -vsig=12 -vemaxs=2 --rsig:shftq=.05,.05,.05 --rs=1,0 -vnit=1 --pr45 --no-iactiv
# To perform TSIGU test, first run gwd/test/test.gwd si.
# Then copy ASCII form of sigma to wd, e.g. cp gwd/test/si/sigma.si .
TSIGU
   rm -f mixm.si
   echo Convert sigma to binary repsn
   lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv --rsig:ascii --wsig
   cp sigm2.si sigm.si
   echo Eigenvectors, occupation number matrix
   lmf --shorbz=no si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 -vnk=4 --wsig:trans=6
   echo Make effective U from sigma
   lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --wsig:trans=10
# Test replacement of sigma with sum_k sigma
TSIG0
  rm -f mixm.si
  lmf si -vsig=12 --rs=1,0 --rsig:ascii -vnit=1 --iactiv=no -vmetal=5
  echo make bands of nonlocal sigma for reference
  lmf si -vsig=12 --rs=1,0 --rsig:ascii -vnit=1 --iactiv=no -vmetal=5 --band:fn=syml
  cp bnds.si bnds.siq
  lmf si -vsig=12 --rs=1,0 --rsig:ascii -vnit=1 --iactiv=no -vmetal=5 --wsig:sumk
  cp sigm2.si sigm.si
  echo make bands of semilocal sigma
  lmf si -vsig=12 --rs=1,0 --rsig:fbz -vnit=1 --iactiv=no -vmetal=5
  lmf si -vsig=12 --rs=1,0 --rsig:fbz -vnit=1 --iactiv=no -vmetal=5 --band:fn=syml
  cp bnds.si bnds.siq0
TSTRS
  rm -f mixm.si
  lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv=no --rsig:ascii
  lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv=no --rsig:ascii --wsig:ascii:rs
  lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv=no --rsig:ascii:rs
  lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv=no --rsig:ascii --wsig:rs
  cp sigm2rs.si sigmrs.si
  lmf si -vsig=12 --rs=1,0 -vnit=1 -vemaxs=2 --pr45 --iactiv=no --rsig:rs
TSIGS
  lmf si -vsig=12 --rsig:ascii "--wsig~edit~showp r<.45 ib=2,3 p<.45 -.25,-.25,-.25 rms~a"
#SYMGRP  E
# SYMGRP  i(1/4,1/4,1/4)
%ifdef scell
SYMGRP  i*r3(1,1,-1):(1/4,1/4,1/4) r4x:(1/4,1/4,1/4)
STRUC   NSPEC=2 NL=5 FILE=sitex
SITE    FILE=sitex
%endif
SYMGRP  find
STRUC   NBAS=4 NSPEC=2 NL=5
        ALAT=a PLAT= 0 .5 .5    .5 0 .5    .5 .5 0 TET=tet
%ifdef rot
        ROT=z:.1,y:2,z:.3
%endif
SITE    ATOM=C1  POS=  0   0   0
        ATOM=C1  POS= .25 .25 .25
        ATOM=EC1 POS= .50 .50   .50
        ATOM=EC1 POS= .75 .75   .75
CLASS
        ATOM=C1 Z=14 R/W=rwc A=.015 EREF=-577.69658
        LMX=3 LMXL=3 LMXA=la1
        RSMH= 1.4,1.4,1.4,1.4 EH= -.2,-.2,-.2,-.2
        RSMH2=1.4,1.4         EH2=-1.2,-1.2

% const lmxe=2
        ATOM=EC1 Z=0 R/W=rwec A=.015
        LMX={lmxe} LMXL=3 LMXA=lae1 BAS:1,0,2,rsm,-.1
        RSMH=1.5,1.5,1.5,1.5 EH=-.2,-.2,-.2,-.2
#       RSMH2=1.4,1.4         EH2=-1.2,-1.2
ITER    MIX=A3,b=1,k=5 CONV=5e-5 CONVC=2e-6 NIT=nit
MIX     MODE=A3,b=1,k=5 CONV=5e-5 CONVC=2e-6
% const gwcode=2
GW      NKABC=nkgw nkgw nkgw GCUTB=2.7 GCUTX=2.2 CODE={gwcode}
% const bzjob=0 metal=0
BZ      NKABC=nk BZJOB={bzjob} EF0=0 DELEF=.1 EFMAX=10
        TETRA=0 METAL={metal} DOS=-1 2 NPTS=1001 INVIT=f PUTQP=f
STR     RMAX=3.5
CONST   a=10.26 bzj=1 lf1=4 lf2=lf1 la1=lf1 lae1=lf2
        rw=.9 rwc=rw rwa=rw rwec=rw rwea=rw
        tet=1 nit=10 nk=5 nkgw=4
EWALD   AS=2.0 TOL=1D-8 ALAT0=a NKRMX=400 NKDMX=400
OPTIONS NSPIN=1 REL=t XCFUN=2 INVIT=f HF=0 PFLOAT=0
IO      SHOW=f HELP=f VERBOS=41 20 41 WKP=F IACTIV=t
% const sig=0 emaxs=3 nmax=0 nsp=1 so=0
% const pwmode=0 pwemin=0 pwemax=3 oveps=0
HAM     NMTO=0 KMTO=-.1 .1 .6 1.1 EWALD=T RDSIG={sig} REL=t NSPIN={so?2:nsp} SO={so}
        AUTOBAS[PNU=0 LOC=0 MTO=0 PFLOAT=0,0 xQLOC=.004]
        PWMODE={pwmode} PWEMIN={pwemin} PWEMAX={pwemax} OVEPS={oveps}
        FORCES={so==0} ELIND=-1 FTMESH=16 XCFUN=2 TOL=1d-8
        SIGP[MODE=3 NMIN=0 EMIN=0 NMAX={nmax} EMAX={emaxs} A=0.02 B=0.06]
% const optmod=0 lteto=3 mefac=0
OPTICS  MODE={optmod} NPTS=2001 WINDOW=0 2 ESCISS=0 LTET={lteto} MEFAC={mefac}
        FILBND=1,4*{so==1?2:1} # EMPBND=10 16 
VERS    LMFP-5.0 LMASA-6 TB-6 LMF-6 FTB-6 LMF:7 LM:7 FP:7
START   CNTROL=0 BEGMOM=0 CNVG=1d-5 NIT=nit
