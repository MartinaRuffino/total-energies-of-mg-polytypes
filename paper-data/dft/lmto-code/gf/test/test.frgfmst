#!/bin/tcsh

set testfile = $0
set testdir = $testfile:h
set topdir  = `cd $testdir/../..; pwd`

set path = ($topdir $topdir/utils $path)

set mcx = `which mcx`
if (-x "$mcx") then
  if `$mcx --h |& grep mc | grep vsn | awk '{print ($7 == "(vsn" && ($8 * 1 >= 1.04))}'` set have_mc
endif
if (! $?have_mc) then
  echo "test.nio6 (abort) : missing mcx"
  exit -1
endif

echo '... test fully relativistic GF in various screening transformations'
# echo $testdir/test.frgf --quiet fe 2
# $testdir/test.frgf --quiet fe 2
echo "   " 'do for gam = 0 1 2 4 5: lmgf -vsym=t -vrel=2 -vnit=1 -vgamma=$gam -vbegmom=0 --pr45,41 -vbeta=1 fe'
rm -f 0 1 2 4 5
foreach gam (0 1 2 4 5)
  rm -f vshft.fe mixm.fe
  cp $testdir/full_rel/3c/{ctrl.fe,a.fe} .
  lmstr -vsym=t -vrel=2 -vnit=1 -vgamma=$gam -vbegmom=0 --pr45,41 -vbeta=1 fe --iactiv=no > /dev/null
  lmgf -vsym=t -vrel=2 -vnit=1 -vgamma=$gam -vbegmom=0 --pr45,41 -vbeta=1 fe --iactiv=no > $gam
end
echo "    RMS DQ for each of the 5 repsns : " `grep DQ  0 1 2 4 5  | vextract . DQ` '  ' fluctuation \
     `grep sumev=  0 1 2 4 5 | vextract . sumev | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
echo "    sumev  for each of the 5 repsns : " `grep sumev= 0 1 2 4 5 | vextract . sumev` '  ' fluctuation \
     `grep sumev=  0 1 2 4 5 | vextract . sumev | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
# set tol = `grep sumev=  0 1 2 4 5 | vextract . sumev | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
set tol = `grep DQ  0 1 2 4 5  | vextract . DQ | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
echo "   " Deviation in magnetic moment for 5 tests averaged relative the bet=alpha result: $tol
if (`echo $tol 0 | awk -v tol=.000001 '{{k=($1-$2)>0?($1-$2):($2-$1);} print (k<=tol)}'`) then
  echo "   " fully relativistic GF test for multiple screening transformations PASSED
else
  echo "   " fully relativistic GF test for multiple screening transformations FAILED
endif
echo



