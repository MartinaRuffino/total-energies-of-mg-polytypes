#!/bin/tcsh

set testfile = $0
set testdir = $testfile:h
set topdir  = `cd $testdir/../..; pwd`

set path = ($topdir $topdir/utils $path)

set mcx = `which mcx`
if (-x "$mcx") then
  if `$mcx --h |& grep mc | grep vsn | awk '{print ($7 == "(vsn" && ($8 * 1 >= 1.04))}'` set have_mc
endif
if (! $?have_mc) then
  echo "test.nio6 (abort) : missing mcx"
  exit -1
endif


#  This test is self-contained
echo '... run the following fully relativistic calculations, mode 10 for gam = 0 2 5'
echo '    Note: rotations algorithm exasa has a bug in the relativistic case.  Symops are suppressed.'
touch  0-rel-job10 ctrl.fept
rm *.fept ?-rel-job10
cp $testdir/ctrl.fept $testdir/rsta.fept.lmgf.ntht=0 .
cp rsta.fept.lmgf.ntht=0 rsta.fept
lmstr fept -vrel=1 -vbegmom=1 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0697730 --rs=1,0 > /dev/null
lmgf fept -vrel=1 -vbegmom=1 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0697730 --rs=1,0 > /dev/null
lmgf fept -vrel=2 -vbegmom=2 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0697730 --quit=rho > /dev/null
foreach gam (0 2 5)
lmgf fept -vgamma=$gam -vrel=2 -vgfmod=10 -vnk=8 -vnc=1 -vntht=0 -vnit=1 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0697730 --nosym > $gam-rel-job10
end
grep -A 2 '2/3 J' *-rel-job10 | grep -v '2/3 J'
set tol = `grep -A 1 '2/3 J' *-rel-job10 | grep job10- | awk '{print $NF}' | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt((x1-avg)^2/nr)' -rsum | tail -1`
grep -A 2 '2/3 J' *-rel-job10 | grep -v '2/3 J' > /dev/null
set retval = $status
echo "   " Deviation in 2/3 J for 2 relativistic exchange calculations : $tol

set tol = 7.5
if ($retval == 0 && `echo $tol 0 | awk -v tol=$tol '{{k=($1-$2)>0?($1-$2):($2-$1);} print (k<=tol)}'`) then
  echo "    fully relativistic GF test mode 10 tol < $tol" PASSED
else
  echo "    fully relativistic GF test mode 10 FAILED"
endif
echo
