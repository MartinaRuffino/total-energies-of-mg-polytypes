#!/bin/tcsh

set testfile = $0
set testdir = $testfile:h
set topdir  = `cd $testdir/../..; pwd`

set path = ($topdir  $topdir/utils $path)

set mcx = `which mcx`
if (-x "$mcx") then
  if `$mcx --h |& grep mc | grep vsn | awk '{print ($7 == "(vsn" && ($8 * 1 >= 1.04))}'` set have_mc
endif
if (! $?have_mc) then
  echo "test.frgfm1 (abort) : missing mcx"
  exit -1
endif

echo '... fully relativistic calculations, mode 1 for gam = 0 1 2 4 5'
#  This test is self-contained
touch  0-rel-job1 ctrl.fept
rm *.fept ?-rel-job1
cp $testdir/ctrl.fept $testdir/rsta.fept.lmgf.ntht=0 .
cp rsta.fept.lmgf.ntht=0 rsta.fept
lmstr fept -vrel=1 -vbegmom=1 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0710713 --rs=1,0 > /dev/null
lmgf fept -vrel=1 -vbegmom=1 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0710713 --rs=1,0 > /dev/null
lmgf fept -vrel=2 -vbegmom=2 -vnit=0 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 --pr31,30 -vidxf=1 --iactiv=no -ef=-0.0710713 --quit=rho > /dev/null
touch  0-rel-job1
echo "   " rm -f save.fept ?-rel-job1
           rm -f save.fept ?-rel-job1
echo '    lmgf fept -vrel=2 -vgfmod=1 -vnk=8 -vnc=1 -vntht=0 -vnit=0 --pr31,30 -vidxf=1 --iactiv=no -vbegmom=2 -ef=-0.0710713'
foreach gam (0 1 2 4 5)
rm -f vshft.fept mixm.fept
lmgf fept -vrel=2 -vgfmod=1 -vnk=8 -vnit=1 --pr31,30 -vidxf=1 --iactiv=no -vbegmom=2 -ef=-0.0710713 --quit=rho -vgamma=$gam --nosym --quit=rho > $gam-rel-job1
end
echo "    RMS DQ for each of the 5 relativistic mode 1 calculations : " `grep DQ  ?-rel-job1 | vextract . DQ`  '  ' fluctuation \
     `grep DQ  ?-rel-job1 | vextract . DQ | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
echo "    sumev  for each of the 5 relativistic mode 1 calculations :  " `grep sumev= ?-rel-job1 | vextract . sumev`  '  ' fluctuation \
     `grep sumev=  ?-rel-job1 | vextract . sumev | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
set tol = `grep sumev=  ?-rel-job1 | vextract . sumev | $mcx . -p -s1/nr -rsum -av avg -pop -e1 'sqrt(((x1-avg+1e-9)^2/nr))'  -rsum | tail -1`
echo "   " Deviation in sumev for 5 SO tests averaged relative the gamma=alpha result: $tol
if (`echo $tol 0 | awk -v tol=.000001 '{{k=($1-$2)>0?($1-$2):($2-$1);} print (k<=tol)}'`) then
  echo "   "  fully relativistic GF test mode 1 gam=0,1,2,4,5 PASSED
else
  echo "   "  fully relativistic GF test mode 1 gam=0,1,2,4,5 FAILED
endif
echo



