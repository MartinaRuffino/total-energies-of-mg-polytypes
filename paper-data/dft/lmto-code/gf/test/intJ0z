#!/bin/tcsh -f
# Integrates integrand in file dj0dz
# ... Meaning of optional ef0:
#     Case not addfile: 
#      Energy axis shifted by -ef0 : new Fermi level will be $efermi-$ef0

# Requires matrix calculator program "mcx" to be in path.

set ef0 = 0
set facJ0 = '13.6/8.617e-5/1e3'
options:
switch ($1)
  case "-ef=*":
    set efermi = `echo $1 | awk '{print substr($1,5)}'` ; shift; goto options

  case "-ef0=*":
    set ef0 = `echo $1 | awk '{print substr($1,6)}'` ; shift; goto options

  case "-add=*":
    set addfile=`echo $1 | sed s/-add=//` ; shift; goto options

  case "-facJ0=*":
    set facJ0=`echo $1 | sed s/-facJ0=//` ; shift; goto options

  case "-*":
     echo 'intJ0z : no switch "'$1'"' ... aborting ; exit -1
endsw

if ($?efermi) then
else
  echo  abort ... no fermi level supplied
  exit -1
endif

if ($#argv == 0) then
  echo "usage: intJ0z -ef=# filename"
  exit -1
endif
if ($#argv != 1) then
  echo missing or extraneous arguments $argv  ... aborting
  exit -1
endif
if (! -f $1) then
  echo file \"$1\" not readable ... aborting
  exit -1
endif

set fn = $1
set emin = `mcx $fn -sub 1,1,1,1 | tail -1`
set emax = `mcx $fn -sub nr,nr,1,1 | tail -1`

if ($?addfile) then
  set nr = `mcx "-vfacJ0=$facJ0" -ff11.6,20f9.2 $fn -p -coll 3:nc -sfacj0 -tog -coll 1 -tog -ccat -int $efermi $emin{:}$emax{:}.001 -p -coll 2:nc -tog -coll 1 -e1 x1-$ef0 -tog -ccat | awk '/rows/, /rows/ {print $3}'`
  echo "% repeat i=1:$nr" >tmp1
  cat $addfile >>tmp1
  echo "% end" >>tmp1
  echo '#mcx' "'""-vfacJ0=$facJ0""'" -ff11.6,20f9.2 $fn -p -coll 3:nc -sfacj0 -tog -coll 1 -tog -ccat -int $efermi $emin{:}$emax{:}.001 -p -coll 2:nc -tog -coll 1 -e1 x1-$ef0 -tog -ccat tmp1 -+ -ccat 
  mcx "-vfacJ0=$facJ0" -ff11.6,20f9.2 $fn -p -coll 3:nc -sfacj0 -tog -coll 1 -tog -ccat -int $efermi $emin{:}$emax{:}.001 -p -coll 2:nc -tog -coll 1 -e1 x1-$ef0 -tog tmp1 -+ -ccat -p -coll 2:nc -vncol=nc -csum -s1/ncol -ccat
else
  echo '# This file was generated by invoking the following command :'
  echo '# mcx '"'""-vfacJ0=$facJ0""'" -vef0=$ef0 -ff11.6,20f9.1 dj0dz -p -coll 3:nc -sfacj0 -tog -coll 1 -e1 x1-ef0 -tog -ccat -int $efermi-$ef0 $emin-$ef0{}:$emax-$ef0{}:.001 
# mcx '"'""-vfacJ0=$facJ0""'" -vef0=$ef0 -ff11.6,20f9.1 $fn -p -coll 3:nc -sfacj0 -tog -coll 1 -tog -ccat -int $efermi $emin{:}$emax{:}.001 -p -e1 x1-ef0 -tog -coll 2:nc -ccat
  echo "# Results are in units of facJ0 (=$facJ0) * units of dj0dz"
#    mcx "-vfacJ0=$facJ0" -vef0=$ef0 -ff11.6,20f9.1 $fn -p -coll 3:nc -sfacj0 -tog -coll 1 -tog -ccat -int $efermi $emin{:}$emax{:}.001 -p -e1 x1-ef0 -tog -coll 2:nc -ccat
    mcx "-vfacJ0=$facJ0" -vef0=$ef0 -ff11.6,20f9.1 dj0dz -p -coll 3:nc -sfacj0 -tog -coll 1 -e1 x1-ef0 -tog -ccat -int $efermi-$ef0 $emin-$ef0{}:$emax-$ef0{}:.001 
endif
